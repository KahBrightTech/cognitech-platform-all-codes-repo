AWSTemplateFormatVersion: 2010-09-09
Description: This creates the IAM role to be used by the ec2 instance
Parameters: 
  pAwsAccount:
    Description: The account in which the resources will be created
    Type: AWS::SSM::Parameter::Value<String>
    Default: /standard/AWSAccount
  
  pAwsAccountLC:
    Description: The account in which the resources will be created
    Type: AWS::SSM::Parameter::Value<String>
    Default: /standard/AWSAccountLC

  pAppName:
    Description: The app cosuming these resources
    Type: String
    Default: cognitech

Resources: 
  rNestedInstanceRole:
    Type: AWS::IAM::Role
    Metadata:
      Comment: This is the role to be used by the instance during the buid
    Properties: 
      RoleName: !Sub ${ pAwsAccount }-${ AWS::Region}-${ pAppName }-role
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: 
              Service:
                - !Sub ec2.${AWS::URLSuffix}
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns: 
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore
        - !Sub arn:${AWS::Partition}:iam::aws:policy/EC2InstanceProfileForImageBuilder
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AmazonEC2FullAccess
      Path: /

# https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-iam-instanceprofile.html
  rNestedIAMProfile:
    Type: AWS::IAM::InstanceProfile
    Properties: 
      Path: /
      Roles: 
        - Ref: rNestedInstanceRole

# https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-iam-policy.html
  rNestedInstanceRoleMiscPolicy:
    Type: AWS::IAM::Policy
    Properties: 
      PolicyName: !Sub ${ pAwsAccount }-${ AWS::Region}-${ pAppName }-misc-policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:*
              - ec2:Describe*
              - ec2:Get*
            Resource: "*"
      Roles: 
        - Ref: "rNestedInstanceRole"
  rNestedBastionInstanceRole:
    Type: AWS::IAM::Role
    Metadata:
      Comment: This is the role to be used by the instance during the buid
    Properties: 
      RoleName: !Sub ${ pAwsAccount }-${ AWS::Region}-${ pAppName }-bastion-role
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: 
              Service:
                - !Sub ec2.${AWS::URLSuffix}
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns: 
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore
      Path: /

# https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-iam-instanceprofile.html
  rBastionIAMProfile:
    Type: AWS::IAM::InstanceProfile
    Properties: 
      Path: /
      Roles: 
        - Ref: rNestedBastionInstanceRole

Outputs:
  oNestedIAMRoleArn:
    Description: The arn of the IAM role 
    Value: !GetAtt rNestedInstanceRole.Arn
    Export: 
      Name: Nested-IAM-Role-Arn
    
  oNestedIAMRoleName:
    Description: The name of the IAM role
    Value: !Ref rNestedInstanceRole
    Export: 
      Name: Nested-IAM-Role-Name
  
  oNestedBastionIAMRoleArn:
    Description: The arn of the IAM role 
    Value: !GetAtt rNestedBastionInstanceRole.Arn
    Export: 
      Name: Nested-Bastion-iam-Role-Arn
    
  oNestedBastionIAMRoleName:
    Description: The name of the IAM role
    Value: !Ref rNestedBastionInstanceRole
    Export: 
      Name: Nested-Bastion-iam-Role-Name