AWSTemplateFormatVersion: 2010-09-09
Description: Creates an aws 3 tier arcitecture with nested stacks
Metadata: # This is putr in an s3 bucket
  AWS::CloudFormation::Interface:
    ParameterGroups: # This groups all the parameter acording to resources created
    - Label:
        default: "Account values"
      Parameters: 
        - pAwsAccount
        - pAwsAccountLC
        - pBucketName
        - pAppName
    - Label: 
        default: "Network configurations" 
      Parameters:
        - pVPCCidr
        - pPrivateSubnet1CIDR
        - pPrivateSubnet2CIDR
        - pPublicSubnet1CIDR
        - pPublicSubnet2CIDR
        - pAvailabilityZones
        - pSharedServicesAccount
        - pSharedServicesVPCCidr
        - pSharedServicesPrivateSubnet1CIDR
        - pSharedServicesPrivateSubnet2CIDR
        - pSharedServicesPublicSubnet1CIDR
        - pSharedServicesPublicSubnet2CIDR
        - pSharedServicesAvailabilityZones
    - Label:
        default: "security group configurations" 
      Parameters: 
        - pVpcid
        - pSharedServicesVPCId
    - Label:
        default: "Transit Gateway configurations" 
      Parameters: 
        - pAmazonAsn
        - pAutoAcceptAttachment
        - pRouteTablePropagation
        - pRouteTableAssociation
        - pDNSSupport
        - pVPNSupport
        - pSharedServicesPrivateSubnet1Id
        - pSharedServicesPrivateSubnet2Id
        - pSharedServicesVPCId
        - pApp1PrivateSubnet1Id
        - pApp1PrivateSubnet2Id
        - pApp1VPCId
        - pTransitGatewayCIDR
        - pApp1NatGateway1Id
        - pApp1NatGateway2Id
        - pSSNatGateway1Id
        - pSSNatGateway2Id
        - pSharedServicesInternetGateway
        - pSharedServicesPublicSubnet1Id
        - pSharedServicesPublicSubnet2Id
    - Label:
        default: "Bastion hosts configurations" 
      Parameters: 
        - pAmznLnx2LatestAmiId
        - pWindows2019LatestAmiId
        - pBastionInstanceProfile
        - pBastionRDPSecurityGroup
        - pBastionSSHSecurityGroup
        - pSharedSeervicesPublicSubnetId
    - Label:
        default: "App Servers configurations" 
      Parameters: 
        - pAppServerInstanceProfile
        - pWindowsAppServerSecurityGroup
        - pLinuxAppServerSecurityGroup
        - pAppServerPrivateSubnetId
    - Label:
        default: "Web Servers configurations" 
      Parameters: 
        - pWebServerInstanceProfile
        - pWindowsWebServerSecurityGroup
        - pLinuxWebServerSecurityGroup
        - pWebServerPrivateSubnetId
    - Label:
        default: "DB Servers configurations" 
      Parameters: 
        - pWindowsDBLatestAmiId
        - pDBServerInstanceProfile
        - pWindowsDBServerSecurityGroup
        - pDBServerPrivateSubnetId 
    
    - Label:
        default: "ALB configuration" 
      Parameters: 
        - pHealthCheckIntervalSeconds
        - pHealthCheckProtocol
        - pHealthCheckPath
        - pHealthCheckPort
        - pHealthCheckTimeoutSeconds
        - pHealthyThresholdCount
        - pPort
        - pProtocol
        - pLinuxTarget1
        - pLinuxTarget2
        - pWindowsTarget1
        - pWindowsTarget2
        - pTargetType
        - pApp1VPCId
        - pdeletionprotectionenabled
        - paccesslogss3enabled
        - paccesslogss3bucket
        - palbscheme
        - palbsubnet1
        - palbsubnet2
        - palbsecuritygroup
        - palbcertificate
        - pSslPolicy
        - palbport
        - palbprotocol
    - Label:
        default: "DNS configuration" 
      Parameters: 
        - pHostedZoneId
        - pLinuxip01
        - plinuxip02
        - pWindowsip01
        - pWindowsip02
        - pDomainName1
        - pDomainName2
        - pDomainIISName
        - palbDNSName

    ParameterLabels: # The default values will be presented on the console 
      pAwsAccount: 
        default: The account name in upper case. 
      pAwsAccountLC: 
        default: The account name in lower case 
      pBucketName: 
        default: The name of the bucket storing all the children stacks 
      pAppName: 
        default: The appplication being created 
  ###########################App vpc parameter labels############################################
      pVPCCidr: 
        default: The vpc cidr range 
      pPrivateSubnet1CIDR: 
        default: The first private subnet cidr range.
      pPrivateSubnet2CIDR: 
        default: The second private subnet cidr range 
      pPublicSubnet1CIDR: 
        default: The first public subnet cidr range
      pPublicSubnet2CIDR: 
        default: The second public subnet cidr range 
      pAvailabilityZones: 
        default: The availability zones on which the resource will be created 
  ###########################App shared services parameter labels#################################
      pSharedServicesAccount: 
        default: The vpc name for shared services 
      pSharedServicesVPCCidr: 
        default: The vpc cidr range for shared services vpc
      pSharedServicesPrivateSubnet1CIDR: 
        default: The first private subnet cidr range for shared services
      pSharedServicesPrivateSubnet2CIDR: 
        default: The second private subnet cidr range for shared services 
      pSharedServicesPublicSubnet1CIDR: 
        default: The first public subnet cidr range for shared services
      pSharedServicesPublicSubnet2CIDR: 
        default: The second public subnet cidr range for shared services
      pSharedServicesAvailabilityZones: 
        default: The availability zones on which the resource will be created for shared services
      pVpcid: 
        default: The vpc id on which the resources will be created 
#############################Transit gateway parameter labels######################################
      pAmazonAsn: 
        default: The Amazon side Autonomous System Number (ASN)
      pAutoAcceptAttachment: 
        default: Do you want to auto accept the tgw attachments?
      pRouteTablePropagation: 
        default: Do you want to automatically propagate the routes to the default route table?
      pRouteTableAssociation: 
        default: Do you want to automatically associate the routes to the default route table?
      pDNSSupport: 
        default:  Do you want to enable DNS suuport?
      pVPNSupport: 
        default: Do you want to enable VPN suuport? 
      pSharedServicesPrivateSubnet1Id: 
        default: The Id of the first shared services private subnet
      pSharedServicesPrivateSubnet2Id: 
        default: The Id of the second shared services private subnet
      pSharedServicesVPCId: 
        default: The Id of the shared services VPC
      pApp1PrivateSubnet1Id: 
        default: The Id of the first App1 private subnet 
      pApp1PrivateSubnet2Id: 
        default: The Id of the second App1 private subnet 
      pApp1VPCId: 
        default: The Id of the App1 VPC
      pTransitGatewayCIDR:
        default: The CIDR range for the transit gateway. Most likely /16 
      pApp1NatGateway1Id:
        default: The Id of the first Nat gateway
      pApp1NatGateway2Id:
        default: The Id of the second Nat gateway
      pSSNatGateway1Id: 
        default: The Id of the first shared services Nat gateway
      pSSNatGateway2Id: 
        default: The Id of the second shared services Nat gateway
      pSharedServicesInternetGateway: 
        default: The Internet gateway id for the shared services vpc
      pSharedServicesPublicSubnet1Id: 
        default: The Id of the first shared services public subnet
      pSharedServicesPublicSubnet2Id: 
        default: The Id of the second shared services public subnet

#######################Bastion hosts parameters ############################### 
      pAmznLnx2LatestAmiId: 
        default: The latest ami Id for amazon linux 2 
      pWindows2019LatestAmiId: 
        default: The latest ami Id for windows 2019
      pBastionInstanceProfile: 
        default: The instance profile for the bastions
      pBastionRDPSecurityGroup: 
        default: The security group for the rdp bastion 
      pBastionSSHSecurityGroup: 
        default: The security group for the ssh bastion
      pSharedSeervicesPublicSubnetId: 
        default: The subnet Id for the shared services public subnet

#######################App servers parameters ############################### 
      pAppServerInstanceProfile: 
        default: The instance profile for the App server
      pWindowsAppServerSecurityGroup:
        default: The windows app server security group 
      pLinuxAppServerSecurityGroup:
        default: The linux app server security group
      pAppServerPrivateSubnetId:
        default: The subnet Id for the app server

#######################Web servers parameters ############################### 
      pWebServerInstanceProfile: 
        default: The instance profile for the web server
      pWindowsWebServerSecurityGroup:
        default: The windows web server security group 
      pLinuxWebServerSecurityGroup:
        default: The linux web server security group
      pWebServerPrivateSubnetId:
        default: The subnet Id for the web server

#######################DB servers parameters ############################### 
      ppWindowsDBLatestAmiId: 
        default: The latest ami Id for windows & SQL
      pDBServerInstanceProfile:
        default: The instance profile for the DB server 
      pWindowsDBServerSecurityGroup:
        default: The windows DB server security group
      pDBServerPrivateSubnetId:
        default: The subnet Id for the DB server

#############################ALB parameters#####################################
      pHealthCheckIntervalSeconds: 
        default: The intervals for health checks
      pHealthCheckProtocol:
        default: The health check protocol 
      pHealthCheckPath:
        default: The path for the alb health check
      pHealthCheckPort:
        default: The health check protocol
      pHealthCheckTimeoutSeconds: 
        default: The amount of time, in seconds, during which no response from a target means a failed health
      pHealthyThresholdCount:
        default: The number of consecutive health check successes required before considering a target healthy
      pPort:
        default: The port on which the targets receive traffic
      pProtocol:
        default: The protocol to use for routing traffic to the targets
      pLinuxTarget1: 
        default: The first linux instance ID behind the target group
      pLinuxTarget2:
        default: The second linux instance ID behind the target group
      pWindowsTarget1:
        default: The first windows instance ID behind the target group
      pWindowsTarget2:
        default: The second windows instance ID behind the target group
      pTargetType: 
        default: The type of target that you must specify when registering targets with this target group
      pdeletionprotectionenabled:
        default: Indicates whether deletion protection is enabled
      paccesslogss3enabled:
        default: Indicates whether access logs are enabled
      paccesslogss3bucket: 
        default: The name of the S3 bucket for the access logs
      palbscheme:
        default: The alb scheme
      palbsubnet1:
        default: The first alb subnet
      palbsubnet2:
        default: The second alb subnet
      palbsecuritygroup: 
        default: The alb security group
      palbcertificate:
        default: The alb certificate
      pSslPolicy:
        default: Security policy to negotiate SSL connections between a client and the load balancer
      palbport:
        default: The port on which the load balancer is listening
      palbprotocol: 
        default: The protocol for connections from clients to the load balancer

#########################################DNS######################################
      pHostedZoneId: 
        default: The DNS hosted zone
      pLinuxip01:
        default: The ip of the first linux server
      plinuxip02:
        default: The ip of the second linux server
      pWindowsip01:
        default: The ip of the first windows server
      pWindowsip02: 
        default: The ip of the second windows server
      pDomainName1:
        default: The domain 1st name
      pDomainName2:
        default: The domain 2nd name
      pDomainIISName:
        default: The domain 3rd name 
      palbDNSName: 
        default: The alb dns name
Parameters: 
####################### General parameter for all stacks #######################
  pAwsAccount:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /standard/AWSAccount
  
  pAwsAccountLC:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /standard/AWSAccountLC

  pBucketName:
    Type: String
    Default: prod-nested-stack-us-east-1
  
  pAppName:
    Type: String
    Default: cognitech
########################## VPC parameters ######################################
  pVPCCidr:
    Type: String
    Default: 10.1.1.0/24
  
  pPrivateSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Type: String
    Default: 10.1.1.0/27
  
  pPrivateSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Type: String
    Default: 10.1.1.32/27
  
  pPublicSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Type: String
    Default: 10.1.1.64/27
  
  pPublicSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Type: String
    Default: 10.1.1.96/27
  
  pAvailabilityZones:
    Type: CommaDelimitedList
    Default: us-east-1a, us-east-1b

########################## Shared services VPC parameters ######################################
  pSharedServicesAccount:
    Type: String
    Default: /standard/SharedServicesVpc
  
  pSharedServicesVPCCidr:
    Type: String
    Default: 10.1.2.0/24
  
  pSharedServicesPrivateSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Type: String
    Default: 10.1.2.0/27
  
  pSharedServicesPrivateSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Type: String
    Default: 10.1.2.32/27
  
  pSharedServicesPublicSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Type: String
    Default: 10.1.2.64/27
  
  pSharedServicesPublicSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Type: String
    Default: 10.1.2.96/27
  
  pSharedServicesAvailabilityZones:
    Type: CommaDelimitedList
    Default: us-east-1a, us-east-1b
  # Security Group parameters
  pVpcid:
    Type: String 
  
  ################################ Transit Gateway ###############################################
  pAmazonAsn:
    Type: String
    Default: 65000
    MinLength: 5
    MaxLength: 10
    ConstraintDescription: The range is 64512 to 65534 for 16-bit ASNs and 4200000000 to 4294967294 for 32-bit ASNs.
  
  pAutoAcceptAttachment:
    Type: String
    Default: "enable"
    AllowedValues:
      - "enable"
      - "disable"
  
  pRouteTablePropagation:
    Type: String
    Default: "enable"
    AllowedValues:
      - "enable"
      - "disable"
  
  pRouteTableAssociation: 
    Type: String
    Default: "enable"
    AllowedValues:
      - "enable"
      - "disable"

  pDNSSupport:
    Type: String
    Default: "enable"
    AllowedValues:
      - "enable"
      - "disable"
  
  pVPNSupport:
    Type: String
    Default: "enable"
    AllowedValues:
      - "enable"
      - "disable"
  
  pSharedServicesPrivateSubnet1Id:
    Type: String

  pSharedServicesPrivateSubnet2Id:
    Type: String

  pSharedServicesVPCId:
    Type: String

  pApp1PrivateSubnet1Id:
    Type: String

  pApp1PrivateSubnet2Id:
    Type: String

  pApp1VPCId:
    Type: String
      
  pTransitGatewayCIDR:
    Type: String 
    Default: 10.1.0.0/16
  
  pApp1NatGateway1Id:
    Type: String
  
  pApp1NatGateway2Id:
    Type: String 
  
  pSSNatGateway1Id:
    Type: String 

  pSSNatGateway2Id:
    Type: String 

  ################################### Bastion hosts #####################################
  pAmznLnx2LatestAmiId:
    Type: String 
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
  
  pWindows2019LatestAmiId:
    Type : String 
    Default: /aws/service/ami-windows-latest/Windows_Server-2019-English-Full-Base
  
  pBastionInstanceProfile:
    Type: String
  
  pBastionRDPSecurityGroup: 
    Type: String
  
  pBastionSSHSecurityGroup:
    Type: String
  
  pSharedSeervicesPublicSubnetId:
    Type: String

  ################################### App servers #####################################
  pAppServerInstanceProfile:
    Type: String
  
  pWindowsAppServerSecurityGroup:
    Type: String
  
  pLinuxAppServerSecurityGroup:
    Type: String
  
  pAppServerPrivateSubnetId:
    Type: String

  ################################### Web servers #####################################
  pWebServerInstanceProfile:
    Type: String
  
  pWindowsWebServerSecurityGroup:
    Type: String
  
  pLinuxWebServerSecurityGroup:
    Type: String
  
  pWebServerPrivateSubnetId:
    Type: String

  ################################### DB servers #####################################
  pWindowsDBLatestAmiId:
    Type: String
    Default: '/aws/service/ami-windows-latest/Windows_Server-2019-English-Full-SQL_2019_Standard'
  
  pDBServerInstanceProfile:
    Type: String
  
  pWindowsDBServerSecurityGroup:
    Type: String
  
  pDBServerPrivateSubnetId:
    Type: String

##########################################ALB################################################
  pHealthCheckIntervalSeconds:
    Type: String
    Default: 30
  
  pHealthCheckProtocol:
    Type: String
    Default: HTTPS
  
  pHealthCheckPath:
    Type: String
    Default: /
  
  pHealthCheckPort:
    Type: String
    Default: 443
  
  pHealthCheckTimeoutSeconds:
    Type: String
    Default: 15 

  pHealthyThresholdCount:
    Type: String
    Default: 5
  
  pPort:
    Type: String
    Default: 443
      
  pProtocol:
    Type: String
    Default: HTTPS
  
  pLinuxTarget1:
    Type: String
 
  pLinuxTarget2:
    Type: String

  pWindowsTarget1:
    Type: String
 
  pWindowsTarget2:
    Type: String
  
  pTargetType:
    Type: String
    Default: instance
  
  pdeletionprotectionenabled:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  paccesslogss3enabled:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
  
  paccesslogss3bucket:
    Type: String
    Default: nestedalbbucket
  
  palbscheme:
    Type: String
    Default: internet-facing
  
  palbsubnet1:
    Type: String

  palbsubnet2:
    Type: String
  
  palbsecuritygroup:
    Type: String
  
  palbcertificate:
    Type: String
    Default: arn:aws:acm:us-east-1:485147667400:certificate/706bda3c-cacf-45b1-b51c-89151b367494
 
  pSslPolicy:
    Type: String
    Default: ELBSecurityPolicy-2016-08

  palbport:
    Type: String

  palbprotocol:
    Type: String

#############################################DNS######################################################
  pHostedZoneId:
    Type: String
    Default: Z0334718LG87PKPVYABM
  
  pLinuxip01:
    Type: String

  plinuxip02:
    Type: String
   
  pWindowsip01:
    Type: String

  pWindowsip02:
    Type: String

  pDomainName1:
    Type: String 
    Default: cobsine.kahbrigthllc.com
  
  pDomainName2:
    Type: String 
    Default: dotnet.kahbrigthllc.com

  pDomainIISName:
    Type: String 
    Default: iis.kahbrigthllc.com

  palbDNSName:
    Type: String 



Resources: 
  rVpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/vpc.yaml
      TimeoutInMinutes: 20
      Parameters:
        pVPCCidr: !Ref pVPCCidr 
        pPrivateSubnet1CIDR: !Ref pPrivateSubnet1CIDR 
        pPrivateSubnet2CIDR: !Ref pPrivateSubnet2CIDR 
        pPublicSubnet1CIDR: !Ref pPublicSubnet1CIDR 
        pPublicSubnet2CIDR: !Ref pPublicSubnet2CIDR 
        pAppName: !Ref pAppName
        pAvailabilityZones:
          Fn::Join:
            - ','
            - !Ref pAvailabilityZones
  
  rSharedServicesVpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/sharedvpc.yaml
      TimeoutInMinutes: 20
      Parameters:
        pSharedServicesAccount: !Ref pSharedServicesAccount
        pSharedServicesVPCCidr: !Ref pSharedServicesVPCCidr 
        pSharedServicesPrivateSubnet1CIDR: !Ref pSharedServicesPrivateSubnet1CIDR 
        pSharedServicesPrivateSubnet2CIDR: !Ref pSharedServicesPrivateSubnet2CIDR 
        pSharedServicesPublicSubnet1CIDR: !Ref pSharedServicesPublicSubnet1CIDR 
        pSharedServicesPublicSubnet2CIDR: !Ref pSharedServicesPublicSubnet2CIDR 
        pSharedServicesAvailabilityZones:
          Fn::Join:
            - ','
            - !Ref pSharedServicesAvailabilityZones
        pAppName: !Ref pAppName

  rIAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/iam.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName

  rSecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/security-group.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName
        pSharedServicesVPCCidr: !Ref pSharedServicesVPCCidr
        pVpcid: 
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oVPC
        pSharedServicesVPCId: 
          Fn::GetAtt: 
            - rSharedServicesVpcStack
            - Outputs.oVPC

  
  rTransitGatewayStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/TransitGateway.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName
        pSharedServicesAccount: !Ref pSharedServicesAccount
        pAmazonAsn: !Ref pAmazonAsn
        pAutoAcceptAttachment: !Ref pAutoAcceptAttachment 
        pRouteTablePropagation: !Ref pRouteTablePropagation 
        pRouteTableAssociation: !Ref pRouteTableAssociation 
        pDNSSupport: !Ref pDNSSupport 
        pVPNSupport: !Ref pVPNSupport 
        pTransitGatewayCIDR: !Ref pTransitGatewayCIDR
        pSharedServicesPrivateSubnet1Id: 
          Fn::GetAtt: 
            - rSharedServicesVpcStack 
            - Outputs.oPrivateSubnet1
        pSharedServicesPrivateSubnet2Id: 
          Fn::GetAtt: 
            - rSharedServicesVpcStack 
            - Outputs.oPrivateSubnet2 
        pSharedServicesVPCId: 
          Fn::GetAtt: 
            - rSharedServicesVpcStack 
            - Outputs.oVPC 
        pApp1PrivateSubnet1Id: 
          Fn::GetAtt: 
            - rVpcStack 
            - Outputs.oPrivateSubnet1
        pApp1PrivateSubnet2Id: 
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oPrivateSubnet2
        pApp1VPCId: 
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oVPC
        pApp1NatGateway1Id:
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oNatGateway1
        pApp1NatGateway2Id:
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oNatGateway2
        pSSNatGateway1Id:
          Fn::GetAtt: 
            - rSharedServicesVpcStack
            - Outputs.oNatGateway1
        pSSNatGateway2Id:
          Fn::GetAtt: 
            - rSharedServicesVpcStack
            - Outputs.oNatGateway2
        pSharedServicesInternetGateway:
          Fn::GetAtt: 
            - rSharedServicesVpcStack
            - Outputs.oInternetGateway
        pSharedServicesPublicSubnet1Id:
          Fn::GetAtt: 
            - rSharedServicesVpcStack
            - Outputs.oPublicSubnet1
        pSharedServicesPublicSubnet2Id:
          Fn::GetAtt: 
            - rSharedServicesVpcStack
            - Outputs.oPublicSubnet2
        
    DependsOn: 
    - rSharedServicesVpcStack
    - rVpcStack

  rBastionHost:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/bastions.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName
        pAmznLnx2LatestAmiId: !Ref pAmznLnx2LatestAmiId
        pWindows2019LatestAmiId: !Ref pWindows2019LatestAmiId
        pBastionInstanceProfile: 
          Fn::GetAtt: 
            - rIAMStack
            - Outputs.oNestedBastionInstanceProfileName
        pBastionRDPSecurityGroup: 
          Fn::GetAtt: 
            - rSecurityGroupStack
            - Outputs.oNestedrdpbastionsg
        pBastionSSHSecurityGroup: 
          Fn::GetAtt: 
            - rSecurityGroupStack
            - Outputs.oNestedsshbastionsg
        pSharedSeervicesPublicSubnetId: 
          Fn::GetAtt: 
            - rSharedServicesVpcStack
            - Outputs.oPublicSubnet1
  
  rAppServers:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/Appservers.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName
        pAmznLnx2LatestAmiId: !Ref pAmznLnx2LatestAmiId
        pWindows2019LatestAmiId: !Ref pWindows2019LatestAmiId
        pAppServerInstanceProfile: 
          Fn::GetAtt: 
            - rIAMStack
            - Outputs.oNestedIAMInstanceProfileName
        pWindowsAppServerSecurityGroup: 
          Fn::GetAtt: 
            - rSecurityGroupStack
            - Outputs.oNestedWindowsAppsg
        pLinuxAppServerSecurityGroup: 
          Fn::GetAtt: 
            - rSecurityGroupStack
            - Outputs.oNestedlinuxAppsg
        pAppServerPrivateSubnetId: 
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oPrivateSubnet1

  rWebServers:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/Webserevers.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName
        pAmznLnx2LatestAmiId: !Ref pAmznLnx2LatestAmiId
        pWindows2019LatestAmiId: !Ref pWindows2019LatestAmiId
        pWebServerInstanceProfile: 
          Fn::GetAtt: 
            - rIAMStack
            - Outputs.oNestedIAMInstanceProfileName
        pWindowsWebServerSecurityGroup: 
          Fn::GetAtt: 
            - rSecurityGroupStack
            - Outputs.oNestedwindowswebsg
        pLinuxWebServerSecurityGroup: 
          Fn::GetAtt: 
            - rSecurityGroupStack
            - Outputs.oNestedlinuxwebsg
        pWebServerPrivateSubnetId: 
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oPrivateSubnet1

  rDBServers:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/database.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName
        pWindowsDBLatestAmiId: !Ref pWindowsDBLatestAmiId
        pDBServerInstanceProfile: 
          Fn::GetAtt: 
            - rIAMStack
            - Outputs.oNestedIAMInstanceProfileName
        pWindowsDBServerSecurityGroup: 
          Fn::GetAtt: 
            - rSecurityGroupStack
            - Outputs.oNestedWindowsDBsg
        pDBServerPrivateSubnetId: 
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oPrivateSubnet1
  
  rALB:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/alb.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName
        pHealthCheckIntervalSeconds: !Ref pHealthCheckIntervalSeconds
        pHealthCheckProtocol: !Ref pHealthCheckProtocol
        pHealthCheckPath: !Ref pHealthCheckPath 
        pHealthCheckPort: !Ref pHealthCheckPort 
        pHealthCheckTimeoutSeconds: !Ref pHealthCheckTimeoutSeconds 
        pHealthyThresholdCount: !Ref pHealthyThresholdCount 
        pPort: !Ref pPort 
        pProtocol: !Ref pProtocol
        pLinuxTarget1: 
          Fn::GetAtt: 
            - rWebServers
            - Outputs.oLinuxWebServerInstanceId02
        pLinuxTarget2: 
          Fn::GetAtt: 
            - rWebServers
            - Outputs.oLinuxWebServerInstanceId01
        pWindowsTarget1: 
          Fn::GetAtt: 
            - rWebServers
            - Outputs.oWindowsWebServerInstanceId01
        pWindowsTarget2: 
          Fn::GetAtt: 
            - rWebServers
            - Outputs.oWindowsWebServerInstanceId02
        pTargetType: !Ref pTargetType 
        pApp1VPCId: !Ref pApp1VPCId 
        pdeletionprotectionenabled: !Ref pdeletionprotectionenabled 
        paccesslogss3enabled: !Ref paccesslogss3enabled
        paccesslogss3bucket: !Ref paccesslogss3bucket 
        palbscheme: !Ref palbscheme 
        palbsubnet1: 
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oPublicSubnet1
        palbsubnet2: 
          Fn::GetAtt: 
            - rVpcStack
            - Outputs.oPublicSubnet2
        palbsecuritygroup:
          Fn::GetAtt: 
            - rSecurityGroupStack
            - Outputs.oNestedalbsg
        palbcertificate: !Ref palbcertificate
        pSslPolicy: !Ref pSslPolicy
        palbport: !Ref palbport 
        palbprotocol: !Ref palbprotocol 
    DependsOn: 
      - rWebServers

  rDNS:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pBucketName}.s3.amazonaws.com/dns.yaml
      TimeoutInMinutes: 20
      Parameters: 
        pAppName: !Ref pAppName
        pHostedZoneId: !Ref pHostedZoneId 
        pLinuxip01: 
          Fn::GetAtt: 
            - rWebServers
            - Outputs.oLinuxWebServerIP01
        plinuxip02: 
          Fn::GetAtt: 
            - rWebServers
            - Outputs.oLinuxWebServerIP02
        pWindowsip01: 
          Fn::GetAtt: 
            - rWebServers
            - Outputs.oWindowsWebServerIP01
        pWindowsip02:
          Fn::GetAtt: 
            - rWebServers
            - Outputs.oWindowsWebServerIP02 
        pDomainName1: !Ref pDomainName1 
        pDomainName2: !Ref pDomainName2 
        pDomainIISName: !Ref pDomainIISName 
        palbDNSName:
          Fn::GetAtt: 
            - rALB
            - Outputs.oalbdnsname
      DependsOn: 
        - rWebServers
        - rALB
  
        
          


  
