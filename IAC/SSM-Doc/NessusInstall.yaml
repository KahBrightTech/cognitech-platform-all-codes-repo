schemaVersion: '2.2'
description: "Document to install Nessus agent on different operating systems"
parameters: {}
mainSteps:
  - action: aws:runShellScript
    name: InstallNessusAgentLinux
    description: |
      Installs Nessus agent on Linux servers
    inputs:
      runCommand:
        - |
          #!/bin/bash -xe
          ##############################################################
          #  INSTALLING AND CONFIGURING NESSUS AGENT  #
          ##############################################################
          OS_TYPE=$(cat /etc/os-release | grep ^ID= | cut -d '=' -f 2 | tr -d '"')
          
          case "$OS_TYPE" in
            "amzn")
              echo "Detected Amazon Linux 2"
              if rpm -q Nessus; then
                echo "Nessus is already installed. Skipping installation."
              else
                aws s3 cp s3://effulgencesoftwareinstall/Nessus/Linux/Amazon-Linux-2/Nessus-10.8.3-amzn2.x86_64.rpm .
                rpm -ivh Nessus-10.8.3-amzn2.x86_64.rpm
              fi
              ;;
            "rhel"|"centos")
              echo "Detected RHEL/CentOS"
              if rpm -q Nessus; then
                echo "Nessus is already installed. Skipping installation."
              else
                aws s3 cp s3://effulgencesoftwareinstall/Nessus/Nessus-10.8.3-el7.x86_64.rpm .
                rpm -ivh Nessus-10.8.3-el7.x86_64.rpm
              fi
              ;;
            "ubuntu")
              echo "Detected Ubuntu"
              if dpkg -l | grep -q nessus; then
                echo "Nessus is already installed. Skipping installation."
              else
                snap install aws-cli --classic
                aws s3 cp s3://effulgencesoftwareinstall/Nessus/Linux/Ubuntu/Nessus-10.8.3-ubuntu1604_amd64.deb .
                dpkg -i Nessus-10.8.3-ubuntu1604_amd64.deb
              fi
              ;;
            *)
              echo "Unsupported Linux distribution"
              exit 1
              ;;
          esac
          
          /bin/systemctl start nessusd.service
          /bin/systemctl enable nessusd.service
    precondition:
      StringEquals:
        - platformType
        - Linux

  - action: aws:runPowerShellScript
    name: InstallNessusAgentWindows
    description: |
      Installs Nessus agent on Windows servers
    inputs:
      runCommand:
        - |
          # PowerShell Script to Install Nessus Agent on Windows
          $S3Path = "s3://effulgencesoftwareinstall/Nessus/Windows/Nessus-10.8.3-x64.msi"
          $DestPath = "C:\Nessus-10.8.3-x64.msi"

          if (Get-Service -Name "Tenable Nessus" -ErrorAction SilentlyContinue) {
              Write-Host "Nessus is already installed. Skipping installation."
          } else {
              Write-Host "Downloading Nessus from S3..."
              aws s3 cp $S3Path $DestPath

              Write-Host "Installing Nessus..."
              Start-Process -FilePath "msiexec.exe" -ArgumentList "/i $DestPath /quiet /norestart" -Wait
          }
          
          Start-Service -Name "Tenable Nessus"
          Set-Service -Name "Tenable Nessus" -StartupType Automatic
    precondition:
      StringEquals:
        - platformType
        - Windows
